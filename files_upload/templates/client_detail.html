{% extends "layout.html" %}
{% block title %}ملفات العميل{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3"><h5 class="mb-0">ملفات العميل</h5><span class="text-muted">{{ user.name or user.email }}</span></div>
<div class="mb-3">
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('admin') if current_user.role == 'admin' else url_for('supervisor') }}">رجوع</a>
</div>
{% if docs|length == 0 %}
<div class="alert alert-info">لا توجد ملفات لهذا العميل.</div>
{% else %}
<div class="table-responsive">
<table class="table table-hover align-middle">
<thead><tr><th>الملف</th><th>النوع</th><th>الحالة</th><th>تاريخ الرفع</th><th>وقت القرار</th><th>سبب الرفض</th><th>إجراءات</th></tr></thead>
<tbody>
{% for d in docs %}
<tr>
<td><a class="filename" href="{{ url_for('files', name=d.filename) }}">{{ d.filename }}</a></td>
<td class="text-muted">{{ doc_type_labels.get(d.doc_type, '—') }}</td>
<td><span class="badge badge-status {{ d.status }}">{% if d.status=='approved' %}مقبول{% elif d.status=='rejected' %}مرفوض{% else %}قيد المراجعة{% endif %}</span></td>
<td>{{ d.created_at|localtime }}</td>
<td>{{ d.reviewed_at|localtime }}</td>
<td>{% if d.status=='rejected' %}{{ d.reason or '—' }}{% else %}—{% endif %}</td>
<td class="d-flex gap-2"><button type="button" class="btn btn-sm btn-outline-secondary btn-preview" data-src="{{ url_for('preview_file', name=d.filename) }}">عرض</button><a href="{{ url_for('files', name=d.filename) }}" class="btn btn-sm btn-outline-primary">تحميل</a>{% if current_user.role in ['admin','supervisor'] %}<a href="{{ url_for('review', id=d.id, status='approved', next=request.path) }}" class="btn btn-approve btn-sm">قبول</a><button type="button" class="btn btn-reject btn-sm" data-id="{{ d.id }}">رفض</button>{% endif %}</td>
</tr>
<tr class="reject-row d-none">
  <td colspan="7">
    <div class="reject-panel">
      <form class="reject-form" method="post" action="/review/{{ d.id }}/reject">
        <div class="mb-3">
          <label for="rejectReason{{ d.id }}" class="form-label">اكتب سبب الرفض</label>
          <textarea id="rejectReason{{ d.id }}" name="reason" class="form-control" rows="3" placeholder="مثال: المستند غير واضح أو ناقص"></textarea>
        </div>
        <input type="hidden" name="next" value="{{ request.path }}">
        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-secondary btn-cancel-reject">إلغاء</button>
          <button type="submit" class="btn btn-danger">تأكيد الرفض</button>
        </div>
      </form>
    </div>
  </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">معاينة الملف</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body p-0"><iframe id="filePreview" class="w-100 modal-iframe" src="" frameborder="0"></iframe></div></div></div></div>



{% endblock %}